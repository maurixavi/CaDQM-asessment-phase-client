<div class="container my-4">
  <app-step-navigator 
    [pageStepTitle]="pageStepTitle" 
    [phaseTitle]="phaseTitle" 
    [stageTitle]="stageTitle" 
    [steps]="steps"
    [currentStep]="currentStep">
  </app-step-navigator>

  <!-- SECTION: Select DQ Methods -->
  <div *ngIf="this.currentDQModel?.status !== 'finished'" >
    <p class="subtitle-description mt-4">Define DQ Methods for each DQ Metric</p>
    <div class="flex-container">
      <div class="section-container">
        <div class="dim-factor-selection-container">
          <div class="label-container">
            <!-- DQ Dimension -->
            <div class="label mb-2">
              <label class="label-title">DQ Dimension:</label>
              <!-- Select para elegir el factor -->
              <span class="label-value d-flex align-items-center">
                <select 
                  class="form-select select-style"
                  id="dqModelDimension"
                  [(ngModel)]="selectedDQModelDimension" 
                  (change)="onDQModelDimensionChange()"
                  aria-label="Select DQ Model dimension"
                >
                  <option value="" disabled>Select a DQ Dimension from the DQ Model</option>
                  <option *ngFor="let dimension of availableDQModelDimensions" [ngValue]="dimension.id">
                    {{ dimension.dimension_name }}
                  </option>
                </select>
              </span>
            </div>
    
            <!-- seleccionar factor -->
            <div class="label mb-2">
              <label class="label-title">DQ Factor:</label>
              <span class="label-value d-flex align-items-center">
                <select 
                  class="form-select select-style" 
                  [(ngModel)]="selectedDQModelFactor"
                  (change)="onDQModelFactorChange()"
                >
                  <option value="" disabled>Select a DQ Factor from the DQ Model</option>
                  <option *ngFor="let factor of availableDQModelFactors" [ngValue]="factor.id">
                    {{ factor.factor_name }}
                  </option>
                </select>
              </span>
            </div>



            <!-- DQ Metric -->
            <div class="label">
              <label class="label-title">DQ Metric:</label>
              <span class="label-value d-flex align-items-center">
                <select 
                  class="form-select select-style" 
                  [(ngModel)]="selectedMetric"
                  (change)="onMetricSelected()"
                >
                  <option value="" disabled>Select a DQ Metric from the DQ Model</option>
                  <option *ngFor="let metric of availableDQModelMetrics" [ngValue]="metric">
                    {{ metric.metric_name }}
                  </option>
                </select>
              </span>
            </div>

            <!-- Show Selected Metric -->
            <div *ngIf="selectedMetric !== null">
              <div class="label-container-selected py-2 px-4">
                <div class="label-selected">
                  <span class="label-name-selected">{{ selectedMetric.metric_name }}</span>
                </div>
                <div class="label-selected">
                  <label class="label-title-selected">Purpose:</label>
                  <span class="label-value-selected">{{ selectedMetric.baseAttr.purpose }}</span>
                </div>
                <div class="label-selected">
                  <label class="label-title-selected">Granularity:</label>
                  <span class="label-value-selected">{{ selectedMetric.baseAttr.granularity }}</span>
                </div>
                <div class="label-selected">
                  <label class="label-title-selected">Result domain:</label>
                  <span class="label-value-selected">{{ selectedMetric.baseAttr.resultDomain }}</span>
                </div>
                <div class="label-selected">
                  <label class="label-title-selected">Influenced by (Ctx. Components):</label>
                  <span class="label-value-selected">
                    <ul class="no-bullets">
                      <li *ngFor="let category of getContextComponentCategories(selectedMetric.context_components)" class="mb-1">
                          <span
                              class="fst-italic"
                              (click)="toggleCategory(selectedMetric.id, category)"
                              style="cursor: pointer;"
                          >
                              <i
                                  class="bi"
                                  [ngClass]="{
                                      'bi-chevron-down': isCategoryExpanded(selectedMetric.id, category),
                                      'bi-chevron-right': !isCategoryExpanded(selectedMetric.id, category)
                                  }"
                              ></i>
                              {{ formatCtxCompCategoryName(category) }}:
                          </span>
                          
                          <!-- Componentes de Contexto para una categoria -->
                          <ul *ngIf="isCategoryExpanded(selectedMetric.id, category)" class="no-bullets px-3 ms-3">
                              <li *ngFor="let componentId of selectedMetric.context_components[category]">
                                  {{ getFirstAttribute(category, componentId) }}
                                  <a href="javascript:void(0)" 
                                     (click)="openContextComponentModal(category, componentId)" 
                                     style="text-decoration: none;">
                                      <i class="bi bi-zoom-in"></i> 
                                  </a>
                              </li>
                          </ul>
                      </li>
                    </ul>
                  </span>
                </div>
              </div>
            </div>

            <!-- DQ Method (de Metrica elegida) -->
            <div class="label mt-2">
              <label class="label-title">DQ Method:</label>
              <span class="label-value d-flex align-items-center">
                <select 
                  class="form-select select-style" 
                  [(ngModel)]="selectedBaseDQMethod"
                  (change)="onMethodSelected()"
                >
                  <option value="" disabled>Select a DQ Method from the DQ Model</option>
                  <option *ngFor="let method of selectedMetric?.baseMethods" [ngValue]="method">
                    {{ method.name }}
                  </option>
                </select>
                <button class="btn btn-light mx-2" (click)="openModalBase(selectedMetric)" [disabled]="!selectedMetric">
                  <i class="bi bi-plus-lg"></i> New DQ Method
                </button>
                <button *ngIf="selectedBaseDQMethod" class="btn btn-outline-danger" (click)="openConfirmationModal(
                    'Delete DQ Method',
                    'Are you sure you want to delete this method? <br><br> ⚠️ <b> It will no longer be available for use in new DQ models, but it will not be removed from existing ones where it has already been added. </b>',
                    'deleteMethodBase',
                    selectedBaseDQMethod.id
                  )">
                    <i class="bi bi-trash3"></i> 
                </button> 
              </span>
            </div>

            <!-- Show Selected Method -->
            <div *ngIf="selectedBaseDQMethod" class="label-container-selected py-2 px-4">
              <div class="label-selected">
                <span class="label-name-selected">{{ selectedBaseDQMethod.name }}</span>
              </div>
              <div class="label-selected">
                <label class="label-title-selected">Input data type:</label>
                <span class="label-value-selected">{{ selectedBaseDQMethod.inputDataType }}</span>
              </div>
              <div class="label-selected">
                <label class="label-title-selected">Output data type:</label>
                <span class="label-value-selected">{{ selectedBaseDQMethod.outputDataType }}</span>
              </div>
              <div class="label-selected">
                <label class="label-title-selected">Algorithm:</label>
                <div class="algorithm-container">
                  <pre class="algorithm-code"><code>{{ selectedBaseDQMethod.algorithm }}</code></pre>
                </div>
              </div>

              <div class="label-selected">
                <label class="label-title-selected">Uses (Ctx. Components):</label>
                <span class="label-value-selected">
                  <div>
                    <ul class="no-bullets">
                      <li *ngFor="let category of getContextComponentCategories(selectionCheckboxCtxComponents)" class="mb-1">
                          <span
                              class="fst-italic"
                              (click)="toggleCategory('selectionCheckbox', category)"
                              style="cursor: pointer;"
                          >
                              <i
                                  class="bi"
                                  [ngClass]="{
                                      'bi-chevron-down': isCategoryExpanded('selectionCheckbox', category),
                                      'bi-chevron-right': !isCategoryExpanded('selectionCheckbox', category)
                                  }"
                              ></i>
                              {{ formatCtxCompCategoryName(category) }}:
                          </span>
                          
                          <!-- Componentes de Contexto para una categoria -->
                          <ul *ngIf="isCategoryExpanded('selectionCheckbox', category)" class="no-bullets px-3 ms-3">
                              <li *ngFor="let component of getComponentsByCategory(selectionCheckboxCtxComponents, category)">
                                  {{ component.value }}
                                  <a href="javascript:void(0)" 
                                     (click)="openContextComponentModal(category, component.id)" 
                                     style="text-decoration: none;">
                                      <i class="bi bi-zoom-in"></i> 
                                  </a>
                              </li>
                          </ul>
                      </li>
                    </ul>

                    <button class="btn btn-light btn-sm mb-4" (click)="toggleCtxSelectionAccordionVisibility()">
                      <i *ngIf="!isEditingCtxComponents"></i>
                      <i *ngIf="isEditingCtxComponents" class="bi bi-eye-slash"></i>
                      {{ isEditingCtxComponents ? 'Hide' : 'Edit' }}
                    </button>
                  </div>
              
                  <div *ngIf="isEditingCtxComponents" class="ctx-selection-accordion-container">
                    <div class="accordion" id="accordionPanelsStayOpenExample">
                      <div *ngFor="let category of getSelectedCategories(); let i = index" class="accordion-item">
                        <h5 class="accordion-header" [id]="'panelsStayOpen-heading' + i">
                          <button
                            class="accordion-button"
                            type="button"
                            data-bs-toggle="collapse"
                            [attr.data-bs-target]="'#panelsStayOpen-collapse' + i"
                            [attr.aria-controls]="'panelsStayOpen-collapse' + i"
                            [attr.aria-expanded]="hasSelectedComponents(category) ? 'true' : 'false'"
                            [class.collapsed]="!hasSelectedComponents(category)"
                            style="padding: 0.1rem 0.9rem;"
                          >
                            {{ formatCtxCompCategoryName(category) }}
                          </button>
                        </h5>
                        <div
                          [id]="'panelsStayOpen-collapse' + i"
                          class="accordion-collapse collapse"
                          [class.show]="hasSelectedComponents(category)"
                          [attr.aria-labelledby]="'panelsStayOpen-heading' + i"
                        >
                          <div class="accordion-body">
                            <div *ngFor="let componentId of selectedMetric.context_components[category]" class="form-check">
                              <ng-container *ngIf="getComponentById(category, componentId) as component">
                                <input
                                  class="form-check-input"
                                  type="checkbox"
                                  [id]="'checkbox-' + category + '-' + component.id"
                                  [checked]="isComponentSelected(category, getFirstNonIdAttribute(component))"
                                  (change)="onCtxComponentsCheckboxChange(component.id, category, getFirstNonIdAttribute(component), $event)"
                                />
                                <label class="form-check-label" [for]="'checkbox-' + category + '-' + component.id">
                                  {{ getFirstNonIdAttribute(component) }}
                                </label>
                              </ng-container>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </span>
              </div>

              <div class="label mt-2">
                <button 
                  class="btn btn-dark" 
                  (click)="openConfirmationModal(
                    'Add to DQ Model',
                    getAddMethodMessage(selectedBaseDQMethod),
                    'addMethodToDQModel',
                    selectedMetric,
                    selectedBaseDQMethod
                  )"
                  [disabled]="!selectedBaseDQMethod">
                  Add to DQ Model
                </button>

              </div>
            </div>
          </div>

          <!-- INFO MESSAGES -->
          <div>
            <div *ngIf="!selectedMetric" class="alert alert-light mb-3 mt-4 px-4">
              <i class="bi bi-info-circle me-1"></i>
              Select an existing DQ Method (that implements a given DQ Metric) or create a new one to add to the DQ Model.
            </div> 
          </div>


        </div>
      </div>

      <!-- Modal for Create Base Method -->
      <div class="modal" tabindex="-1" role="dialog" [ngClass]="{'show': isModalBaseOpen}" [style.display]="isModalBaseOpen ? 'block' : 'none'">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Create a new DQ Method</h5>
              <button type="button" class="close" aria-label="Close" (click)="closeModalBase()">
                <span aria-hidden="true"><i class="bi bi-x-lg"></i></span>
              </button>
            </div>
            <div class="modal-body">
              <form>
                <div [formGroup]="dqMethodForm" class="form-group"> 
                  <label for="name">Name</label>
                  <input type="text" id="name" formControlName="name" name="name" class="form-control" [value]="suggestion?.name || ''"/>
                </div>
                <div [formGroup]="dqMethodForm" class="form-group">
                  <label for="inputDataType">Input Data Type</label>
                  <input type="text" class="form-control" id="inputDataType" formControlName="inputDataType" name="inputDataType" [value]="suggestion?.inputDataType || ''"/>     
                </div>
                <div [formGroup]="dqMethodForm" class="form-group">
                  <label for="outputDataType">Output Data Type</label>
                  <input type="text" class="form-control" formControlName="outputDataType" id="outputDataType" name="outputDataType" [value]="suggestion?.outputDataType || ''"/>
                </div>
                <div [formGroup]="dqMethodForm" class="form-group">
                  <label for="algorithm">Algorithm</label>
                  <textarea id="algorithm" name="algorithm" formControlName="algorithm" rows="4" class="form-control" placeholder="Define the SQL query logic used by this DQ Method to implement the DQ Metric..." [value]="suggestion?.algorithm || ''"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer border-top-0">
              <button type="button" class="btn btn-sm btn-ai" (click)="generateNewSuggestion()" style="width: auto;" [disabled]="isLoading">
                <i class="bi bi-stars"></i>
                <span *ngIf="!isLoading">Generate</span>
                <span *ngIf="isLoading">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  Generating...
                </span>
              </button>
              <button type="button" class="btn btn-sm btn-light" (click)="closeModalBase()">Cancel</button>
              <button 
                type="button" 
                class="btn btn-sm btn-dark" 
                (click)="openConfirmationModal(
                  'Create DQ Method',
                  'Are you sure you want to create this DQ Method? Once created, it will be available for selection and addition to the DQ Model.',
                  'createDQMethodBase',
                  selectedMetric
                )"
                [disabled]="!dqMethodForm.valid">
                Confirm
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION: Define Applied DQ Methods -->
  <div *ngIf="this.currentDQModel?.status !== 'finished'" >
    <p class="subtitle-description mt-4">Define Applied DQ Methods for each DQ Methods</p>
    <div class="flex-container">
      <div class="section-container">
        <div class="dim-factor-selection-container">

          <div class="label-container">
            <!-- DQ Dimension -->
            <div class="label mb-2">
              <label class="label-title">DQ Dimension:</label>
              <!-- Select para elegir el factor -->
              <span class="label-value d-flex align-items-center">
                <select 
                  class="form-select select-style"
                  id="dqModelDimension"
                  [(ngModel)]="selectedDQModelDimension_appliedMethods" 
                  (change)="onDQModelDimensionChange2()"
                  aria-label="Select DQ Model dimension"
                >
                  <option value="" disabled>Select a DQ Dimension from the DQ Model</option>
                  <option *ngFor="let dimension of availableDQModelDimensions" [ngValue]="dimension.id">
                    {{ dimension.dimension_name }}
                  </option>
                </select>
              </span>
            </div>
          </div>

          <!-- Info message 1 -->
          <div class="alert alert-light mb-3 mt-3">
            <i class="bi bi-info-circle me-1"></i>
            Filter existing DQ Methods by DQ Dimension to define Applied DQ Methods for each method.
          </div> 

        
          <div class="applied-methods-container" *ngIf="selectedDQModelDimension_appliedMethods && filteredMethods.length > 0">
            <table class="table table-hover">
              <thead class="thead-dark custom-thead">
                <tr>
                  <th>DQ Dimension</th>
                  <th>DQ Factor</th>
                  <th>DQ Metric</th>
                  <th>DQ Method</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let method of filteredMethods">
                  <td>{{ method.dqDimension }}</td>
                  <td>{{ method.dqFactor }}</td>
                  <td>{{ method.dqMetric }}</td>
                  <td class="fw-medium">
                    {{ method.dqMethod }}
                  </td>
       
                  <td>
                    <button 
                      class="btn btn-sm btn-dark" 
                      
                      (click)="openCreateAppliedMethodModal(method.id)">
                      <i class="bi bi-plus-lg"></i> Applied Method
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          
            
          </div>

          <!-- Info message 2 -->
          <div *ngIf="selectedDQModelDimension_appliedMethods && filteredMethods.length === 0" class="alert alert-warning">
            <i class="bi bi-info-circle me-1"></i>
            There is no DQ Methods found for this filter.
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Creating Applied DQ Method -->
  <div class="modal" tabindex="-1" role="dialog" [ngClass]="{'show': isCreateAppliedMethodModalOpen}" [style.display]="isCreateAppliedMethodModalOpen ? 'block' : 'none'">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create and Add the Applied DQ Method</h5>
          <button type="button" class="close" aria-label="Close" (click)="closeCreateAppliedMethodModal()">
            <span aria-hidden="true"><i class="bi bi-x-lg"></i></span>
          </button>
        </div>
        <div class="modal-body">
          <form [formGroup]="appliedMethodForm">
            <div class="form-group">
              <label for="appliedMethodName">Name</label>
              <input
                type="text"
                id="appliedMethodName"
                formControlName="name"
                class="form-control"
                [placeholder]="selectedMethodObject ? selectedMethodObject.method_name + '...' : 'Enter the name of the applied method'"
              />
            </div>
            
            <div class="form-group">
              <label for="appliedMethodType">Type</label>
              <select
                id="appliedMethodType"
                formControlName="type"
                class="form-select"
                (change)="onTypeChange()"
              >
                <option value="Measurement">Measurement</option>
                <option value="Aggregated">Aggregated</option>
            
              </select>
            </div>
            
            <div class="form-group">
              <label for="appliedMethodGranularity">Granularity</label>
              <input
                type="text"
                id="appliedMethodGranularity"
                class="form-control"
                [value]="selectedMetricBaseDetails?.granularity || 'Not available'"
                readonly
              />
            </div>
          
            <div class="form-group">
              <label for="appliedMethodAppliedTo">Applied To</label>
              <select
                id="appliedMethodAppliedTo"
                formControlName="appliedTo"
                class="form-select"
                [multiple]="selectedMetricBaseDetails?.granularity?.toLowerCase() !== 'column'"
              >
                <option value="">Select an attribute</option>
                <option *ngFor="let option of dataColumnOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="appliedMethodAlgorithm">Applied Algorithm</label>
              <textarea
                id="appliedMethodAlgorithm"
                formControlName="algorithm"
                rows="4"
                class="form-control"
                [placeholder]="selectedMethodObject ? selectedMethodObject.algorithm + '...' : 'Enter the algorithm implementation to execute the DQ Metric'"
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-sm btn-light" (click)="closeCreateAppliedMethodModal()">Cancel</button>
          <!--<button type="button" class="btn btn-sm btn-dark" (click)="createAppliedMethod()" [disabled]="appliedMethodForm.invalid">Create</button>-->
          <button 
                type="button" 
                class="btn btn-sm btn-dark" 
                (click)="openConfirmationModal(
                  'Define Applied DQ Method',
                  'Are you sure you want to define and add this Applied DQ Method to the DQ Model?',
                  'defineAppliedMethod'
                )"
                [disabled]="!appliedMethodForm.valid">
                Create
              </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION: Show DQ Methods added to DQ Model -->
  <div>
    <p class="subtitle-description mt-4">DQ Methods added to DQ Model</p>

    <div class="flex-container" style="margin-bottom: 80px;">
      <div class="section-container">

        <!-- Spinner de carga -->
        <div *ngIf="!allMetrics" class="text-center">
          <div class="spinner-border" role="status">
            <span class="sr-only"></span>
          </div>
        </div>

        <div>
          <div class="label-container-selected py-2 px-4">

            <!-- Spinner de carga -->
            <div *ngIf="!currentDQModel" class="text-center">
              <div class="spinner-border" role="status">
                <span class="sr-only"></span>
              </div>
            </div>

            <div *ngIf="currentDQModel"> 
              <div class="dqmodel-title">
                <span class="label-name-dqmodel">{{ currentDQModel?.name }} {{ currentDQModel?.version }}</span>
                <span *ngIf="currentDQModel?.status === 'finished'" class="badge rounded-pill bg-dark">Finished</span>
                <span *ngIf="currentDQModel?.status === 'draft'" class="badge rounded-pill bg-warning">Draft</span>
              </div>
              <div class="label-selected">
                <label class="label-title-selected">Created:</label>
                <span class="label-value-selected">{{ currentDQModel?.created_at | date:'d MMM yyyy, HH:mm' }}</span>
              </div> 
              <div *ngIf="currentDQModel?.status === 'finished'" class="label-selected">
                <label class="label-title-selected">Finished:</label>
                <span class="label-value-selected">{{ currentDQModel?.finished_at | date:'d MMM yyyy, HH:mm' }}</span>
              </div>
              <div class="label-selected">
                <label class="label-title-selected">Context version:</label>
                <span class="label-value-selected">{{ contextVersion?.name }} {{ contextVersion?.version }}
                  <a href="javascript:void(0)" (click)="contextModal.openModal()" style="text-decoration: none;">
                    <i class="bi bi-zoom-in"></i>
                  </a>
                </span>
              </div>  
              <div class="label-selected">
                <label class="label-title-selected">Data at hand:</label>
                <span class="label-value-selected">DB: {{ dataAtHandDetails?.name }} - {{ dataAtHandDetails?.description }} <a href="javascript:void(0)" (click)="dataAtHandModal.openModal()" style="text-decoration: none;">
                  <i class="bi bi-zoom-in"></i>
                  </a>
                </span>
              </div>

              <div class="divider"></div>

              <div class="label-selected label-dq-item">
                <label class="label-title-selected">DQ Metrics:</label>
              </div>
            </div>

            <div class="dimensions-factors-selected-accordion-container">
              <div class="accordion mx-1" id="accordionMetrics">
                <div class="accordion-item mb-2" *ngFor="let metric of allMetrics; let i = index" style="border: 1px solid #dee2e6; border-radius: 5px; overflow: hidden;">
                  <h2 class="accordion-header" [id]="'metricHeading' + i">
                    <button
                      class="accordion-button"
                      [ngClass]="{ 'collapsed': !metric.expanded }"
                      type="button"
                      data-bs-toggle="collapse"
                      [attr.data-bs-target]="'#metricCollapse' + i"
                      [attr.aria-expanded]="metric.expanded"
                      [attr.aria-controls]="'metricCollapse' + i"
                      style="padding: 0.6rem 0.9rem;">
                      <span>
                        <label class="label-title w-auto">DQ Metric:</label>
                        <span class="label-title-name px-2">{{ metric.metric_name }} 
                        <i *ngIf="!metric.definedMethods || metric.definedMethods.length === 0" 
                          class="bi bi-exclamation-circle-fill text-warning rounded-circle p-1"
                          style="font-size: 14px; cursor: help;"
                          title="No methods yet"
                        ></i>
                          <!--<span class="px-1 fw-light" style="font-size: 12px;">(measures Coverage | facet of Accuracy)</span>-->
                        </span>
                      </span>
                    </button>
                  </h2>
                  <div
                    [id]="'metricCollapse' + i"
                    class="accordion-collapse collapse"
                    [class.show]="metric.expanded"
                    [attr.aria-labelledby]="'metricHeading' + i">
                    <div class="accordion-body">
                      <div class="label-selected">
                        <label class="label-title-selected">Purpose:</label>
                        <span class="label-value-selected">{{ metric.baseAttr.purpose }}</span>
                      </div>
                      <div class="label-selected">
                        <label class="label-title-selected">Granularity:</label>
                        <span class="label-value-selected">{{ metric.baseAttr.granularity }}</span>
                      </div>
                      <div class="label-selected">
                        <label class="label-title-selected">Result domain:</label>
                        <span class="label-value-selected">{{ metric.baseAttr.resultDomain }}</span>
                      </div>

                      <div class="divider"></div>

                      <!-- Influenced by (Ctx. Components) -->
                      <div class="label-selected">
                        <label class="label-title-selected">Influenced by (Ctx. Components):</label>
                        <span class="label-value-selected">
                            <ul class="no-bullets">
                                <li *ngFor="let category of getContextComponentCategories(metric.context_components)" class="mb-1">
                                    <span
                                        class="fst-italic"
                                        (click)="toggleCategory(metric.id, category)"
                                        style="cursor: pointer;"
                                    >
                                        <i
                                            class="bi"
                                            [ngClass]="{
                                                'bi-chevron-down': isCategoryExpanded(metric.id, category),
                                                'bi-chevron-right': !isCategoryExpanded(metric.id, category)
                                            }"
                                        ></i>
                                        {{ formatCtxCompCategoryName(category) }}:
                                    </span>
                                    
                                    <!-- Componentes de Contexto para una categoria -->
                                    <ul *ngIf="isCategoryExpanded(metric.id, category)" class="no-bullets px-3 ms-3">
                                        <li *ngFor="let componentId of metric.context_components[category]">
                                            {{ getFirstAttribute(category, componentId) }}
                                            <a href="javascript:void(0)" 
                                               (click)="openContextComponentModal(category, componentId)" 
                                               style="text-decoration: none;">
                                                <i class="bi bi-zoom-in"></i> 
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </span>
                      </div>


                      <div class="divider"></div>

                      <div class="label-selected label-dq-item">
                        <label class="label-title-selected">DQ Methods:</label>
                      </div>

                      <!-- Mensaje cuando no hay Metodos definidos -->
                      <div *ngIf="!metric.definedMethods || metric.definedMethods.length === 0" >
                        <div class="px-2 py-2">
                          <div  class="alert alert-warning ">
                            <i class="bi bi-exclamation-circle me-2"></i>
                            No methods have been defined for this metric. <br> 
                            Defining at least one for each method will be necessary to complete the DQ Model and perform the DQ measurement.
                          </div>
                        </div>
                      </div>

                      <!-- DQ Methods -->
                      <div class="accordion mx-1 mb-2" id="accordionMethods">
                        <div class="accordion-item" *ngFor="let item of metric.definedMethods; let j = index">
                          <h2 class="accordion-header" [id]="'methodHeading' + j">
                            <button
                              class="accordion-button"
                              [ngClass]="{ 'collapsed': !item.expanded }"
                              type="button"
                              data-bs-toggle="collapse"
                              [attr.data-bs-target]="'#methodCollapse' + j"
                              [attr.aria-expanded]="item.expanded"
                              [attr.aria-controls]="'methodCollapse' + j"
                              style="padding: 0.6rem 0.9rem;">
                              <span>
                                <label class="label-title w-auto">DQ Method:</label>
                                <span class="label-title-name px-2">{{ item.method_name }}</span>
                                <i *ngIf="!item.applied_methods.aggregations.length && !item.applied_methods.measurements.length"
                                  class="bi bi-exclamation-circle-fill text-warning rounded-circle p-1"
                                  style="font-size: 14px; cursor: help;"
                                  title="No applied methods yet"
                                ></i>
                              </span>
                            </button>
                          </h2>
                          <div
                            [id]="'methodCollapse' + j"
                            class="accordion-collapse collapse"
                            [class.show]="item.expanded"
                            [attr.aria-labelledby]="'methodHeading' + j">
                            <div class="accordion-body">
                              <div class="label-selected">
                                <label class="label-title-selected">Name:</label>
                                <span class="label-value-selected">{{ item.baseAttr.name }}</span>
                              </div>
                              <div class="label-selected">
                                <label class="label-title-selected">Input data type:</label>
                                <span class="label-value-selected">{{ item.baseAttr.inputDataType }}</span>
                              </div>
                              <div class="label-selected">
                                <label class="label-title-selected">Output data type:</label>
                                <span class="label-value-selected">{{ item.baseAttr.outputDataType }}</span>
                              </div>
                              <div class="label-selected">
                                <label class="label-title-selected">Algorithm:</label>
                                <div class="algorithm-container">
                                  <pre class="algorithm-code"><code>{{ item.baseAttr.algorithm }}</code></pre>
                                </div>
                              </div>

                              <div class="divider"></div>
                              
                              <!-- Uses (Ctx. Components) --->
                              <div class="label-selected">
                                <label class="label-title-selected">Uses (Ctx. Components):</label>
                                <span class="label-value-selected">
                                  <!-- Ctx components - Solo lectura -->
                                  <div *ngIf="!item.isEditing">
                                    <ul class="no-bullets">
                                        <li *ngFor="let category of getContextComponentCategories(item.context_components)" class="mb-1">
                                            <span
                                                class="fst-italic"
                                                (click)="toggleCategory(item.id, category)"
                                                style="cursor: pointer;"
                                            >
                                                <i
                                                    class="bi"
                                                    [ngClass]="{
                                                        'bi-chevron-down': isCategoryExpanded(item.id, category),
                                                        'bi-chevron-right': !isCategoryExpanded(item.id, category)
                                                    }"
                                                ></i>
                                                {{ formatCtxCompCategoryName(category) }}:
                                            </span>
                                            
                                            <!-- Componentes de Contexto para una categoria -->
                                            <ul *ngIf="isCategoryExpanded(item.id, category)" class="no-bullets px-3 ms-3">
                                                <li *ngFor="let componentId of item.context_components[category]">
                                                    {{ getFirstAttribute(category, componentId) }}
                                                    <a href="javascript:void(0)" (click)="openContextComponentModal(category, componentId)" style="text-decoration: none;">
                                                        <i class="bi bi-zoom-in"></i> 
                                                    </a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>

                                  <!-- Edicion - Solo lectura -->
                                    <div *ngIf="item.isEditing"  class="ctx-selection-accordion-container">
                                      <div class="accordion" id="accordionPanelsStayOpenExample">
                                        <div *ngFor="let category of getContextComponentCategories(metric.context_components); let i = index" class="accordion-item">
                                          <h5 class="accordion-header" [id]="'panelsStayOpen-heading' + i">
                                            <button
                                              class="accordion-button"
                                              type="button"
                                              data-bs-toggle="collapse"
                                              [attr.data-bs-target]="'#panelsStayOpen-collapse' + i"
                                              [attr.aria-controls]="'panelsStayOpen-collapse' + i"

                                              [attr.aria-expanded]="categoryHasCtxComponents_editing(category, item.tempContextComponents)"
                                              [class.collapsed]="!categoryHasCtxComponents_editing(category, item.tempContextComponents)"
                                              
                                              style="padding: 0.1rem 0.9rem;"
                                            >
                                              {{ formatCtxCompCategoryName(category) }}
                                            </button>
                                          </h5>
                                          <div
                                            [id]="'panelsStayOpen-collapse' + i"
                                            class="accordion-collapse collapse"
                                            [class.show]="categoryHasCtxComponents_editing(category, item.tempContextComponents)"
                                            [attr.aria-labelledby]="'panelsStayOpen-heading' + i"
                                          >
                                            <div class="accordion-body">
                                              <div *ngFor="let componentId of metric.context_components[category]" class="form-check">
                                                <ng-container *ngIf="getComponentById(category, componentId) as component">
                                                  <input
                                                    class="form-check-input"
                                                    type="checkbox"
                                                    [id]="'checkbox-' + category + '-' + component.id"
                                                    [checked]="isCtxComponentSelected_editing(category, component.id, item.tempContextComponents)"
                                                    (change)="onCtxComponentsCheckboxChange_methodEditing(component.id, category, item)"
                                                  />
                                                  <label class="form-check-label" [for]="'checkbox-' + category + '-' + component.id">
                                                    {{ getFirstNonIdAttribute(component) }}
                                                  </label>
                                                </ng-container>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                </span>
                              </div>

                              <div class="divider"></div>
                              
                              <div class="label-selected label-dq-item">
                                <label class="label-title-selected">Applied Methods:</label>
                              </div>

                              <!-- Mensaje cuando no hay Metodos Aplicados definidos -->
                              <div *ngIf="!item.applied_methods.aggregations.length && !item.applied_methods.measurements.length">
                                <div class="px-2 py-2">
                                  <div  class="alert alert-warning ">
                                    <i class="bi bi-exclamation-circle me-2"></i>
                                    No applied methods have been defined for this method. <br> 
                                    Defining at least one for each method will be necessary to complete the DQ Model.
                                  </div>
                                </div>
                              </div>
                              
                              <div *ngIf="item && (item.applied_methods?.aggregations?.length > 0 || item.applied_methods?.measurements?.length > 0)">  
                                <!-- Accordion for Measurement Applied Methods -->
                                <div *ngIf="item.applied_methods.measurements.length > 0">
                                  <div class="accordion mx-1 mb-2" id="accordionMeasurementMethods">
                                    <div class="accordion-item" *ngFor="let appliedMethod of item.applied_methods.measurements; let j = index">
                                      <h2 class="accordion-header" [id]="'measurementHeading' + j">
                                        <button
                                          class="accordion-button"
                                          [ngClass]="{ 'collapsed': !appliedMethod.expanded }"
                                          type="button"
                                          data-bs-toggle="collapse"
                                          [attr.data-bs-target]="'#measurementCollapse' + j"
                                          [attr.aria-expanded]="appliedMethod.expanded"
                                          [attr.aria-controls]="'measurementCollapse' + j"
                                          style="padding: 0.6rem 0.9rem;">
                                          <span>
                                            <label class="label-title w-auto">Measurement DQ Method:</label>
                                            <span class="label-title-name  px-2">{{ appliedMethod.name }}</span>
                                          </span>
                                        </button>
                                      </h2>
                                      <div
                                        [id]="'measurementCollapse' + j"
                                        class="accordion-collapse collapse"
                                        [class.show]="appliedMethod.expanded"
                                        [attr.aria-labelledby]="'measurementHeading' + j">
                                        <div class="accordion-body">
                                          <div class="label-selected">
                                            <label class="label-title-selected">Applied to:</label>
                                            <span class="label-value-selected">
                                              <div *ngFor="let table of getAppliedToDisplay(appliedMethod.appliedTo)" 
                                                class="table-display">
                                                Table: <code>{{ table.tableName }}</code><br>
                                                Columns: <code>{{ table.columns.join(', ') }}</code><br><br>
                                              </div>
                                            </span>
                                          </div>

                                          <div class="label-selected">
                                            <label class="label-title-selected w-auto">Implementation:</label>
                                            <div class="algorithm-container">
                                              <pre class="algorithm-code"><code>{{ appliedMethod.algorithm }}</code></pre>
                                            </div>
                                          </div>

                                          <div *ngIf="currentDQModel.status === 'draft'" class="mt-3 mb-2">
                                            <button (click)="deleteAppliedMethod(appliedMethod)" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3"></i> Remove Applied DQ Method</button>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Accordion for Aggregated Applied Methods -->
                                <div *ngIf="item.applied_methods.aggregations.length > 0" class="mt-3">
                                <div class="accordion mx-1 mb-2" id="accordionAggregatedMethods">
                                  <div class="accordion-item" *ngFor="let appliedMethod of item.applied_methods.aggregations; let i = index">
                                    <h2 class="accordion-header" [id]="'aggregatedHeading' + i">
                                      <button
                                        class="accordion-button"
                                        [ngClass]="{ 'collapsed': !appliedMethod.expanded }"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        [attr.data-bs-target]="'#aggregatedCollapse' + i"
                                        [attr.aria-expanded]="appliedMethod.expanded"
                                        [attr.aria-controls]="'aggregatedCollapse' + i"
                                        style="padding: 0.6rem 0.9rem;">
                                        <span>
                                          <label class="label-title w-auto">Aggregation DQ Method:</label>
                                          <span class="label-title-name px-2">{{ appliedMethod.name }}</span>
                                        </span>
                                      </button>
                                    </h2>
                                    <div
                                      [id]="'aggregatedCollapse' + i"
                                      class="accordion-collapse collapse"
                                      [class.show]="appliedMethod.expanded"
                                      [attr.aria-labelledby]="'aggregatedHeading' + i">
                                      <div class="accordion-body">
                                        <div class="label-selected">
                                          <label class="label-title-selected">Applied to:</label>
                                          <span class="label-value-selected">
                                            <div *ngFor="let table of getAppliedToDisplay(appliedMethod.appliedTo)" 
                                              class="table-display">
                                              Table: <code>{{ table.tableName }}</code><br>
                                              Columns: <code>{{ table.columns.join(', ') }}</code><br><br>
                                            </div>
                                          </span>
                                        </div>

                                        <div class="label-selected">
                                          <label class="label-title-selected w-auto">Implementation:</label>
                                          <div class="algorithm-container">
                                            <pre class="algorithm-code"><code>{{ appliedMethod.algorithm }}</code></pre>
                                          </div>
                                        </div>

                                        <div *ngIf="currentDQModel.status === 'draft'" class="mt-3 mb-2">
                                          <button (click)="deleteAppliedMethod(appliedMethod)" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3"></i> Remove Applied DQ Method</button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                </div>

                              </div>
                              

                              <!-- Delete / Edit Metric Buttons -->
                              <div *ngIf="currentDQModel.status === 'draft'">
                                <div class="d-flex gap-2 mt-3 mb-2">
                                  <!-- Remove DQ Method from DQ Model -->
                                  <button 
                                    class="btn btn-outline-danger btn-sm" 
                                    (click)="openConfirmationModal(
                                      'Remove DQ Method from DQ Model',
                                      'Are you sure you want to remove this method from the DQ Model? This will also delete all its applied methods.',
                                      'removeDQMethodFromDQModel',
                                      metric, item
                                    )">
                                    <i class="bi bi-trash3"></i> Remove DQ Method
                                  </button> 
                                 
                                  <!-- Edit DQ Metric Ctx components -->
                                  <button class="btn btn-light btn-sm"
                                    (click)="enableDQMethodEdition(item)">
                                    <span *ngIf="!item.isEditing">
                                      <i class="bi bi-pencil"></i> Edit
                                    </span>
                                    <span *ngIf="item.isEditing">
                                      Cancel
                                    </span>
                                  </button>

                                  <button *ngIf="item.isEditing" class="btn btn-dark btn-sm flex-grow-0"
                                      (click)="saveMethodContextComponents(item)">
                                        Save Changes
                                  </button>

                                </div>
                              </div>


                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <p *ngIf="errorMessage" class="error-message">{{ errorMessage }}</p>
      </div>
    </div>
  </div>
</div>

<app-confirmation-modal
  [isOpen]="isConfirmationModalOpen"
  [title]="confirmationModalTitle"
  [message]="confirmationModalMessage"
  (confirm)="handleConfirm()"
  (cancel)="handleCancel()">
</app-confirmation-modal>

<app-context-component-view-modal
  #contextComponentModal
  [selectedComponentKeys]="selectedComponentKeys"
  [selectedComponentDetails]="selectedComponentDetails">
</app-context-component-view-modal>

<app-data-at-hand-view-modal
  #dataAtHandModal
  [dataAtHandDetails]="dataAtHandDetails"
  [dataSchema]="dataSchema">
</app-data-at-hand-view-modal>

<app-context-components #contextModal></app-context-components>

<app-stepper
  [currentStep]="currentStep"
  [totalSteps]="steps.length"
  [isNextStepEnabled]="isNextStepEnabled"
  (stepChange)="onStepChange($event)">
</app-stepper>
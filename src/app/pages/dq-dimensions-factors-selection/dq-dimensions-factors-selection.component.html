<div class="container my-4">
  <app-step-navigator 
    [pageStepTitle]="pageStepTitle" 
    [phaseTitle]="phaseTitle" 
    [stageTitle]="stageTitle" 
    [steps]="steps"
    [currentStep]="currentStep">
  </app-step-navigator>

  <!-- SECTION #1: Add Dimensions and Factors from scratch -->
  <div>
    <!-- 1. Add Dimensions and Factors from scratch -->
    <div>
      <p 
        class="subtitle-description mt-4" 
        *ngIf="this.currentDQModel?.status !== 'finished'" 
        (click)="toggleFromScratchSectionVisibility()" 
        style="cursor: pointer;"
        [attr.data-tooltip]="!isFromScratchSectionVisible ? 
        'In this section, you can define DQ Dimensions and DQ Factors from scratch, or select and add existing or new ones to the DQ Model. This process is informed by context components and aligned with prioritized DQ problems to focus on key improvement areas.' : null">
        Define DQ Dimensions and DQ Factors from scratch
        <i class="bi" [ngClass]="isFromScratchSectionVisible ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
      </p>

      <div class="subtitle-description mb-2 mx-2" *ngIf="isFromScratchSectionVisible">
        <!-- 1. Add Dimensions -->
        <span 
          (click)="toggleFromScratchSectionVisibility_addDimensions()" 
          style="cursor: pointer;"
          [class.active-section]="isFromScratchSectionVisible_addDimensions">
          Add DQ Dimension 
          <i class="bi" [ngClass]="{
            'bi-chevron-up': isFromScratchSectionVisible_addDimensions,
            'bi-chevron-down': !isFromScratchSectionVisible_addDimensions
          }"></i>
        </span>
        
        <!-- 2. Add Factors -->
        <span 
          class="px-4"
          (click)="toggleFromScratchSectionVisibility_addFactors()" 
          style="cursor: pointer;"
          [class.active-section]="isFromScratchSectionVisible_addFactors">
          Add DQ Factor 
          <i class="bi" [ngClass]="{
            'bi-chevron-up': isFromScratchSectionVisible_addFactors,
            'bi-chevron-down': !isFromScratchSectionVisible_addFactors
          }"></i>
        </span>
      </div>

      <!-- SECTION #1.a: Add Dimensions -->
      <div 
        class="flex-container" 
        id="dimension-factor-selection" 
        *ngIf="this.currentDQModel?.status !== 'finished' && isFromScratchSectionVisible_addDimensions">
        <div class="section-container">
          <div class="dim-factor-selection-container">
            <div class="label-container">
              <!-- DQ Dimension -->
              <div class="label">
                <label class="label-title">DQ Dimension:</label>
                <span class="label-value d-flex align-items-center">
                  <select 
                    class="form-select select-style"   
                    id="dqDimension"
                    [(ngModel)]="selectedDimension" 
                    (change)="onDimensionChange()"
                    aria-label="Default select example">
                    <option value="" disabled>Select an existing DQ Dimension</option>
                    <option *ngFor="let dimension of dqDimensionsBase" [ngValue]="dimension.id">
                      {{ dimension.name }}
                    </option>
                  </select>
                  <button class="btn btn-light mx-2" (click)="openDimensionModal()">
                    <i class="bi bi-plus-lg"></i> New DQ Dimension
                  </button>
                  <!-- Delete Dimension base -->
                  <button *ngIf="selectedDimension && selectedDimensionIsEditable" class="btn btn-outline-danger" (click)="openConfirmationModal(
                    'Delete DQ Dimension',
                    'Are you sure you want to delete this dimension? <br><br> ⚠️ <b> It will no longer be available for use in new DQ models, but it will not be removed from existing ones where it has already been added. </b>',
                    'deleteDimensionBase',
                    selectedDimension
                  )">
                    <i class="bi bi-trash3"></i> 
                  </button> 
                </span>
              </div>

              <!-- Add New Dimension modal form -->
              <div class="modal" tabindex="-1" role="dialog" [ngClass]="{'show': isDimensionModalOpen}" [style.display]="isDimensionModalOpen ? 'block' : 'none'">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Create a new DQ Dimension</h5>
                      <button type="button" class="close" aria-label="Close" (click)="closeDimensionModal()">
                        <span aria-hidden="true"><i class="bi bi-x-lg"></i></span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <form (ngSubmit)="createDimension()">
                        <div class="form-group">
                          <label for="dimensionName">Name</label>
                          <input type="text" class="form-control" id="dimensionName" [(ngModel)]="dimensionName" name="dimensionName" placeholder="Enter DQ Dimension name" required>
                        </div>
                        <div class="form-group">
                          <label for="dimensionSemantic">Semantic</label>
                          <input type="text" class="form-control" id="dimensionSemantic" [(ngModel)]="dimensionSemantic" name="dimensionSemantic" placeholder="Enter DQ Dimension semantic" required>
                        </div>
                        <div *ngIf="errorMessage" class="text-danger">{{ errorMessage }}</div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-sm btn-light" (click)="closeDimensionModal()">Cancel</button>
                      <button type="submit" class="btn btn-sm btn-dark" (click)="createDimension()">Confirm</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Show Selected Dimension -->
              <div *ngIf="selectedDimension !== null">
                <div class="label-container-selected px-4 mt-3">
                  <div class="label-selected">
                    <span class="label-name-selected">{{ getSelectedDimension()?.name }}</span>
                  </div>
                  <div class="label-selected">
                    <label class="label-title-selected">Semantic:</label>
                    <span class="label-value-selected">{{ getSelectedDimension()?.semantic }}</span>
                  </div>  
                </div>
              </div>
            </div>

            <!-- INFO MESSAGES -->
            <div class="px-4">
              <div *ngIf="!selectedDimension" class="alert alert-light mb-3 mt-4">
                <i class="bi bi-info-circle me-1"></i>
                Select or create a new DQ Dimension to add it to the DQ Model.
              </div> 

              <div class="alert alert-info mb-3 mt-4 d-flex align-items-start">
                <i class="bi bi-info-circle me-2 mt-1"></i>
                <div>
                  The identification of context components facilitates the suggestion and selection of relevant data quality dimensions.<br>
                  Aligning these choices with prioritized DQ problems helps target the most critical areas for improvement.
                </div>
              </div>
            </div>
            
            <!-- CTX COMPONENTES & DQ PROBLEMS SELECTION-->
            <div class="ctx-and-problems-main-container">
              <!-- From Context Components selection -->
              <div class="ctx-components-selection-container">
                <div class="d-flex justify-content-between px-2" style="gap: 2px;">
                  <div class="from-ctx-components flex-fill">
                    <div class="label-selected">
                      <label class="label-title-selected-ctx">Suggested by (Ctx. Components):</label>
                    </div>
      
                    <!-- Components select values -->
                    <div class="ctx-selection-accordion-container">
                      <div class="accordion" id="accordionPanelsStayOpenExample">
                        <div *ngFor="let category of categories; let i = index" class="accordion-item">
                          <h6 class="accordion-header" [id]="'panelsStayOpen-heading' + i">
                            <button
                              class="accordion-button"
                              type="button"
                              data-bs-toggle="collapse"
                              [attr.data-bs-target]="'#panelsStayOpen-collapse' + i"
                              [attr.aria-controls]="'panelsStayOpen-collapse' + i"
                              [attr.aria-expanded]="i === 0 ? 'true' : 'false'"
                              [class.collapsed]="i !== 0"
                              style="padding: 0.6rem 0.9rem;">
                              {{ formatCtxCompCategoryName(category) }}
                            </button>
                          </h6>
                          <div
                            [id]="'panelsStayOpen-collapse' + i"
                            class="accordion-collapse collapse"
                            [class.show]="i === 0"
                            [attr.aria-labelledby]="'panelsStayOpen-heading' + i">
                            <div class="accordion-body">
                              <div *ngFor="let item of allContextComponents[category]" class="form-check">
                                <input
                                  class="form-check-input"
                                  type="checkbox"
                                  [id]="'checkbox-' + category + '-' + item.id"
                                  [checked]="isComponentSelected(category, getFirstNonIdAttribute(item))"
                                  (change)="onCtxComponentsCheckboxChange_fromScratch(item.id, category, getFirstNonIdAttribute(item), $event)"/>
                                <label class="form-check-label" [for]="'checkbox-' + category + '-' + item.id">
                                  {{ getFirstNonIdAttribute(item) }}
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div> 
                </div>
              </div>

              <!-- From DQ Problems selection -->
              <div class="dq-problems-selection-container">
                <div class="d-flex justify-content-between px-2" style="gap: 2px;">
                  <div class="from-ctx-components flex-fill">
                    <div class="label-selected">
                      <label class="label-title-selected-ctx">From DQ Problems:</label>
                    </div>

                    <!-- DQ Problems select values -->
                    <div class="dq-problems-accordion-container">
                      <div class="ctx-selection-accordion-container">
                        <div class="checkbox-container">
                          <div *ngFor="let problem of selectedPrioritizedProblems; let i = index" class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              [id]="'checkbox' + i"
                              [value]="problem"
                              (change)="onCheckboxProblemsChange(problem, $event)"/>
                            <label class="form-check-label" [for]="'checkbox' + i">
                              {{ problem.description }}
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div> 
                </div>
              </div>
            </div>

            <button
              type="button"
              class="btn btn-sm btn-dark mt-4"
              (click)="openConfirmationModal(
                'Add to DQ Model',
                'Are you sure you want to add this dimension and factor to the DQ Model?',
                'addDimensionToDQModel',
                selectedDimension,
                ctxComponentsChecked_fromScratch,
                selectedProblemsFromScratch
              )"
              [disabled]="!selectedDimension">
              Add to DQ Model
            </button>
          </div>
        </div>
      </div>

      <!-- SECTION #1.b: Add Factors -->
      <div 
        class="flex-container" 
        id="dimension-factor-selection" 
        *ngIf="isFromScratchSectionVisible_addFactors && this.currentDQModel?.status !== 'finished'">
        <div class="section-container">
          <div class="dim-factor-selection-container">
            <div class="label-container">
              <!-- Select Dimension in DQ Model -->
              <div class="label">
                <label class="label-title">DQ Dimension:</label>
                <span class="label-value d-flex align-items-center">
                  <select 
                    class="form-select select-style"   
                    id="dqModelDimension"
                    [(ngModel)]="selectedDQModelDimension" 
                    (change)="onDQModelDimensionChange()"
                    aria-label="Select DQ Model dimension">
                    <option value="" disabled>Select a DQ Dimension from the DQ Model</option>
                    <option *ngFor="let dimension of availableDQModelDimensions" [ngValue]="dimension.id">
                      {{ dimension.dimension_name }}
                    </option>
                  </select>
                </span>
              </div>

              <!-- Select Factor Base -->
              <div class="label mt-2">
                <label class="label-title">DQ Factor:</label>
                <span class="label-value d-flex align-items-center">
                  <select 
                    id="dqFactor" 
                    class="form-select select-style"
                    [(ngModel)]="selectedFactor"
                    (ngModelChange)="onFactorChange()" 
                    [disabled]="!selectedDQModelDimension || availableFactors.length === 0">
                    <option value="" disabled>Select an existing DQ Factor</option>
                    <option *ngFor="let factor of availableFactors" [ngValue]="factor.id">
                      {{ factor.name }}
                    </option>
                  </select>
                  <button class="btn btn-light mx-2" (click)="openFactorModal()">
                    <i class="bi bi-plus-lg"></i> New DQ Factor
                  </button>
                  <!-- Delete Factor base -->
                  <button *ngIf="selectedFactor && selectedFactorIsEditable" 
                    class="btn btn-outline-danger" 
                    (click)="openConfirmationModal(
                    'Delete DQ Factor',
                    'Are you sure you want to delete this factor? <br><br> ⚠️ <b> It will no longer be available for use in new DQ models, but it will not be removed from existing ones where it has already been added. </b>',
                    'deleteFactorBase',
                    selectedFactor
                  )">
                    <i class="bi bi-trash3"></i> 
                  </button> 
                </span>
              </div>

              <!-- No Factors message -->
              <div *ngIf="noFactorsMessage" class="alert alert-warning mt-2">
                {{ noFactorsMessage }}
              </div>

              <!-- Add New Factor modal form -->
              <div class="modal" tabindex="-1" role="dialog" [ngClass]="{'show': isFactorModalOpen}" [style.display]="isFactorModalOpen ? 'block' : 'none'">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Create a new DQ Factor</h5>
                      <button type="button" class="close" aria-label="Close" (click)="closeFactorModal()">
                        <span aria-hidden="true"><i class="bi bi-x-lg"></i></span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <form (ngSubmit)="createFactorBase()">
                        <div class="form-group">
                          <label for="factorName">Name</label>
                          <input type="text" class="form-control" id="factorName" [(ngModel)]="factorName" name="factorName" placeholder="Enter DQ Factor name" required>
                        </div>
                        <div class="form-group">
                          <label for="factorSemantic">Semantic</label>
                          <input type="text" class="form-control" id="factorSemantic" [(ngModel)]="factorSemantic" name="factorSemantic" placeholder="Enter DQ Factor semantic" required>
                        </div>
                        <div class="form-group">
                          <label for="selectedDimension">Selected Dimension</label>
                          <input type="text" class="form-control" id="selectedDimension" [value]="selectedDimensionName" readonly>
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-sm btn-light" (click)="closeFactorModal()">Cancel</button>
                      <button type="submit" class="btn btn-sm btn-dark" (click)="createFactorBase()">Confirm</button>
                    </div>
                  </div>
                </div>
              </div>

              <div *ngIf="errorMessage" class="text-danger">{{ errorMessage }}</div>

              <!-- Show Selected Factor -->
              <div *ngIf="selectedFactor !== null">
                <div class="label-container-selected py-2 px-4">
                  <div class="label-selected">
                    <span class="label-name-selected">{{ this.selectedFactorDetails?.name }}</span>
                  </div>
                  <div class="label-selected">
                    <label class="label-title-selected">Semantic:</label>
                    <span class="label-value-selected">{{ this.selectedFactorDetails?.semantic }}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- INFO MESSAGES -->
            <div class="px-4">
              <div *ngIf="!selectedFactor" class="alert alert-light mb-3 mt-4">
                <i class="bi bi-info-circle me-1"></i>
                Select or create a new DQ Factor (facet of a given DQ Dimension already in the model) to add it to the DQ Model.
              </div> 

              <div class="alert alert-info mb-3 mt-4 d-flex align-items-start">
                <i class="bi bi-info-circle me-2 mt-1"></i>
                <div>
                  The identification of context components facilitates the suggestion and selection of relevant data quality factors.<br>
                  Aligning these choices with prioritized DQ problems helps target the most critical areas for improvement.
                </div>
              </div>
            </div>

            <!-- CTX COMPONENTES & DQ PROBLEMS SELECTION-->
            <div class="ctx-and-problems-main-container">
              <!-- From Context Components selection -->
              <div class="ctx-components-selection-container">
                <div class="d-flex justify-content-between px-2" style="gap: 20px;">
                  <div class="from-ctx-components flex-fill">
                    <div class="label-selected">
                      <label class="label-title-selected-ctx">Arises from (Ctx. Components):</label>
                    </div>
                    
                    <!-- Components select values -->
                    <div class="ctx-selection-accordion-container"> 
                      <div class="accordion" id="accordionPanelsStayOpenExample">
                        <div *ngFor="let category of categories; let i = index" class="accordion-item">
                          <h6 class="accordion-header" [id]="'panelsStayOpen-heading' + i">
                            <button
                              class="accordion-button"
                              type="button"
                              data-bs-toggle="collapse"
                              [attr.data-bs-target]="'#panelsStayOpen-collapse' + i"
                              [attr.aria-controls]="'panelsStayOpen-collapse' + i"
                              [attr.aria-expanded]="i === 0 ? 'true' : 'false'"
                              [class.collapsed]="i !== 0"
                              style="padding: 0.6rem 0.9rem;">
                              {{ formatCtxCompCategoryName(category) }}
                            </button>
                          </h6>
                          <div
                            [id]="'panelsStayOpen-collapse' + i"
                            class="accordion-collapse collapse"
                            [class.show]="i === 0"
                            [attr.aria-labelledby]="'panelsStayOpen-heading' + i">
                            <div class="accordion-body">
                              <div *ngFor="let item of allContextComponents[category]" class="form-check">
                                <input
                                  class="form-check-input fw-medium"
                                  type="checkbox"
                                  [id]="'checkbox-' + category + '-' + item.id"
                                  [checked]="isComponentSelected(category, getFirstNonIdAttribute(item))"
                                  (change)="onCtxComponentsCheckboxChange_fromScratch(item.id, category, getFirstNonIdAttribute(item), $event)"/>
                                <label class="form-check-label" [for]="'checkbox-' + category + '-' + item.id">
                                  {{ getFirstNonIdAttribute(item) }}
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div> 
                </div>
              </div>

              <!-- From DQ Problems selection -->
              <div class="dq-problems-selection-container">
                <div class="d-flex justify-content-between px-4" style="gap: 20px;">
                  <div class="from-ctx-components flex-fill">
                    <div class="label-selected">
                      <label class="label-title-selected-ctx">From DQ Problems:</label>
                    </div>
        
                    <span class="label-value d-flex align-items-center">
                      <div class="context-selection">
                        <div class="selected-components mt-3" *ngIf="selectedComponents.length > 0">
                          <ul class="list-group">
                            <li *ngFor="let component of selectedComponents" class="list-group-item">
                              {{component.displayText}}
                              <button class="btn btn-danger btn-sm float-end">X</button>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </span>
        
                    <!-- DQ Problems select values -->
                    <div class="dq-problems-accordion-container">
                      <div class="ctx-selection-accordion-container">
                        <div class="checkbox-container">
                          <div *ngFor="let problem of selectedPrioritizedProblems; let i = index" class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              [id]="'checkbox' + i"
                              [value]="problem"
                              (change)="onCheckboxProblemsChange(problem, $event)"/>
                            <label class="form-check-label" [for]="'checkbox' + i">
                              {{ problem.description }}
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div> 
                </div>
              </div>
            </div>

            <button
              type="button"
              class="btn btn-sm btn-dark mt-4"
              (click)="openConfirmationModal(
                'Add to DQ Model',
                'Are you sure you want to add this dimension and factor to the DQ Model?',
                'addFactorDQModel',
                selectedDQModelDimension,
                selectedFactor,
                ctxComponentsChecked_fromScratch,
                selectedProblemsFromScratch
              )"
              [disabled]="!selectedDQModelDimension || !selectedFactor">
              Add to DQ Model
            </button>

            <div *ngIf="duplicateFactor" class="alert alert-warning mt-2">
              Este par de dimensión y factor ya ha sido agregado.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION: Add Dimensions and Factors from DQ Problems -->
  <div>
    <p 
      class="subtitle-description mt-4" 
      *ngIf="currentDQModel?.status !== 'finished'" 
      (click)="toggleFromProblemsSectionVisibility()" 
      style="cursor: pointer;"
      [attr.data-tooltip]="!isFromProblemsSectionVisible ? 
      'This section allows you to select relevant DQ Dimensions and Factors based on previously prioritized DQ Problems. The most critical problems will guide suggestions. If a Dimension or Factor is already in the DQ Model, the selected problem will be associated with it.' : null">
      Select DQ Dimensions and DQ Factors based on the selected prioritized DQ Problems
      <i class="bi" [ngClass]="isFromProblemsSectionVisible ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
    </p>

    <div class="flex-container" *ngIf="isFromProblemsSectionVisible && currentDQModel?.status !== 'finished'">
      <div class="section-container">
        <div>
          <div class="dim-factor-selection-container">
            <div class="label-container">
              <div class="label">
                <label class="label-title">DQ Problem:</label>
                <span class="label-value d-flex align-items-center">
                  <select 
                    class="form-select select-style-problems"   
                    id="dqProblem"
                    [(ngModel)]="selectedProblem" 
                    (change)="onProblemChange()"
                    aria-label="Default select example">
                    <option value="" disabled>Select existing</option>
                    <option *ngFor="let problem of selectedPrioritizedProblems" [ngValue]="problem.id">
                      {{ problem.description }} 
                    </option>
                  </select>
                </span>
              </div>

              <!-- Select Problem -->
              <div *ngIf="selectedProblem !== null">
                <div class="label-container-selected mt-4 px-4">
                  <div class="label-selected">
                    <span class="label-selected-problem-title">
                      {{ getSelectedProblemDetails()?.description }}
                    </span> 
                    <span
                      class="badge rounded-pill"
                      [ngClass]="{
                        'bg-danger': getSelectedProblemDetails()?.priority === 'High',
                        'bg-warning': getSelectedProblemDetails()?.priority === 'Medium',
                        'bg-success': getSelectedProblemDetails()?.priority === 'Low'
                      }">
                      {{ getSelectedProblemDetails()?.priority }}
                    </span>
                  </div>
                  <div class="label-selected">
                    <label class="label-title-selected">Date:</label>
                    <span class="label-value-selected">
                      {{ getSelectedProblemDetails()?.date | date:'MMM dd HH:mm yyyy' }}
                    </span>
                  </div> 
                </div>
              </div>
            </div>

            <!-- INFO MESSAGES -->
            <div class="px-4">
              <div class="alert alert-info mb-4 mt-4 d-flex align-items-start">
                <i class="bi bi-info-circle me-2 mt-1"></i>
                <div> The most relevant DQ problems, according to the prioritization before carried out, can suggest certain DQ dimensions and factors, helping you focus on the most critical areas for improvement.
                </div>
              </div>

              <div class="alert alert-light mb-4 mt-4 d-flex align-items-start" *ngIf="selectedProblem">
                <i class="bi bi-info-circle me-2 mt-1"></i>
                <div>
                  Select existing DQ Dimensions and DQ Factors to add to the DQ Model, based on a given prioritized DQ Problem. <br> 
                  If the dimension or factor has already been added to the DQ Model, the DQ Problem will be associated with that existing element.
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-between px-4">
              <div>
                <!-- Dimensions and Factors selection -->
                <div *ngIf="selectedProblem !== null" class="label-container container-dim-factors">
                  <div *ngFor="let dimFactor of dimensionsWithFactors" class="label-container">
                    <!-- DQ Dimension -->
                    <div class="label" [ngClass]="{ 'dimension-selected': isDimensionSelectedFromDQProblems(dimFactor.dimension.id) }">
                      <label class="label-title">DQ Dimension:</label>
                      <span class="label-value-dim-from-problem">
                        {{ dimFactor.dimension.name }} 
                        <i 
                          class="bi bi-info-circle" 
                          data-bs-toggle="tooltip" 
                          data-bs-placement="top" 
                          [attr.title]="dimFactor.dimension.semantic">
                        </i>
                        <input 
                          type="checkbox" 
                          [checked]="isDimensionSelectedFromDQProblems(dimFactor.dimension.id)" 
                          disabled
                          class="hidden-checkbox">
                      </span>
                    </div>
                
                    <!-- DQ Factors of given Dimension -->
                    <div class="label">
                      <label class="label-title">DQ Factors:</label>
                    </div>
                    <div class="factors-container ms-4">
                      <div *ngFor="let factor of dimFactor.factors" class="form-check">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          [id]="'factor-' + factor.id" 
                          [checked]="isFactorSelectedFromDQProblems(factor.id)" 
                          (change)="onFactorChangeFromDQProblems(factor.id, dimFactor.dimension.id, $event)">
                        <label class="form-check-label" [for]="'factor-' + factor.id">
                          {{ factor.name }} 
                          <i 
                            class="bi bi-info-circle" 
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top" 
                            [attr.title]="factor.semantic">
                          </i>
                        </label>
                      </div>
                    </div>
                    <br>
                  </div>
                </div>
              </div> 
            </div>

            <div *ngIf="selectedProblem !== null">
              <button class="btn btn-dark btn-sm mt-4" (click)="addDimensionsAndFactorsFromDQProblems()">Add to DQ Model</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION: Suggested Dimensions and Factors -->
  <!-- Modal de configuración para generación de sugerencia -->
  <div class="modal" tabindex="-1" role="dialog" [ngClass]="{'show': isSuggestionConfigModalOpen}" [style.display]="isSuggestionConfigModalOpen ? 'block' : 'none'">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Configure AI Suggestion</h5>
          <button type="button" class="close" aria-label="Close" (click)="closeSuggestionConfigModal()">
            <span aria-hidden="true"><i class="bi bi-x-lg"></i></span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <!--
            <div class="form-group">
              <label class="mb-3">Select data sources to consider:</label>
              
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="useContextComponents" 
                      [(ngModel)]="suggestionConfig.useContextComponents" name="useContextComponents" checked>
                <label class="form-check-label" for="useContextComponents">
                  Use Context Components
                </label>
              </div>
              
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="useDQProblems" 
                      [(ngModel)]="suggestionConfig.useDQProblems" name="useDQProblems" checked>
                <label class="form-check-label" for="useDQProblems">
                  Use DQ Problems
                </label>
              </div>
              
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="useExistingModel" 
                      [(ngModel)]="suggestionConfig.useExistingModel" name="useExistingModel">
                <label class="form-check-label" for="useExistingModel">
                  Consider existing DQ Model
                </label>
              </div>
            </div> -->

            <!--
            <div class="form-group">
              <label class="mb-3">Prevent these Dimensions or Factors from being recommended:</label>
              <div class="form-check mb-2">
                <div class="d-flex justify-content-between px-4">
                  <div>
            
                    <div  class="label-container container-dim-factors">
                      <div *ngFor="let dimFactor of dimensionsWithFactors" class="label-container">
                  
                        <div class="label" [ngClass]="{ 'dimension-selected': isDimensionSelectedFromDQProblems(dimFactor.dimension.id) }">
                          <label class="label-title">DQ Dimension:</label>
                          <span>
                            {{ dimFactor.dimension.name }} 
                            <i 
                              class="bi bi-info-circle" 
                              data-bs-toggle="tooltip" 
                              data-bs-placement="top" 
                              [attr.title]="dimFactor.dimension.semantic">
                            </i>
                            <input 
                              type="checkbox" 
                              [checked]="isDimensionSelectedFromDQProblems(dimFactor.dimension.id)" 
                              disabled
                              class="hidden-checkbox">
                          </span>
                        </div>
                    
                        <div class="label">
                          <label class="label-title">DQ Factors:</label>
                        </div>
                        <div class="factors-container ms-4">
                          <div *ngFor="let factor of dimFactor.factors" class="form-check">
                            <input 
                              class="form-check-input" 
                              type="checkbox" 
                              [id]="'factor-' + factor.id" 
                              [checked]="isFactorSelectedFromDQProblems(factor.id)" 
                              (change)="onFactorChangeFromDQProblems(factor.id, dimFactor.dimension.id, $event)">
                            <label class="form-check-label" [for]="'factor-' + factor.id">
                              {{ factor.name }} 
                              <i 
                                class="bi bi-info-circle" 
                                data-bs-toggle="tooltip" 
                                data-bs-placement="top" 
                                [attr.title]="factor.semantic">
                              </i>
                            </label>
                          </div>
                        </div>
                        <br>
                      </div>
                    </div>
                  </div> 
                </div>
              </div>
        
            </div>-->
            
            <div class="form-group">
              <label class="mb-2">Avoid suggesting Dimension-Factor pairs related to:</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="focusAccuracy" 
                      [(ngModel)]="suggestionConfig.excludeAccuracy" name="excludeAccuracy" value="accuracy">
                <label class="form-check-label" for="focusAccuracy">
                  Accuracy-oriented <i 
                    class="bi bi-info-circle" 
                    data-bs-toggle="tooltip" 
                    data-bs-placement="top" 
                    title="Indicates that the data is correct and precise. Includes factors like: Semantic Accuracy, Syntactic Accuracy, Precision.">
                    </i>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="focusCompleteness" 
                      [(ngModel)]="suggestionConfig.excludeCompleteness" name="excludeCompleteness" value="completeness">
                <label class="form-check-label" for="focusCompleteness">
                  Completeness-oriented <i 
                  class="bi bi-info-circle" 
                  data-bs-toggle="tooltip" 
                  data-bs-placement="top" 
                  title="Refers to the availability of all necessary data, ensuring that no important data is missing for analysis or decision-making. Includes factors like: Density, Coverage.">
                  </i>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="focusConsistency" 
                      [(ngModel)]="suggestionConfig.excludeConsistency" name="excludeConsistency" value="consistency" checked>
                <label class="form-check-label" for="focusConsistency">
                  Consistency-oriented <i 
                  class="bi bi-info-circle" 
                  data-bs-toggle="tooltip" 
                  data-bs-placement="top" 
                  title="Ensures that the data is coherent across different sources and over time, maintaining integrity and reliability. Includes factors like: Domain Integrity, Intra-relationship Integrity, Inter-relationship Integrity.">
                  </i>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="focusUniqueness" 
                      [(ngModel)]="suggestionConfig.excludeUniqueness" name="excludeUniqueness" value="uniqueness" checked>
                <label class="form-check-label" for="focusUniqueness">
                  Uniqueness-oriented <i 
                  class="bi bi-info-circle" 
                  data-bs-toggle="tooltip" 
                  data-bs-placement="top" 
                  title="Indicates that each data entry must be unique, with no duplicates present in the dataset. Includes factors like: No-duplication, No-contradiction.">
                  </i>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="foucsFreshness" 
                      [(ngModel)]="suggestionConfig.excludeFreshness" name="excludeFreshness" value="freshness" checked>
                <label class="form-check-label" for="foucsFreshness">
                  Freshness-oriented <i 
                  class="bi bi-info-circle" 
                  data-bs-toggle="tooltip" 
                  data-bs-placement="top" 
                  title="Refers to the recency and update status of the data, indicating whether the data is current and up-to-date. Includes factors like: Currency, Timeliness, Volatility.">
                  </i>
                </label>
              </div>
            </div>
    
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-sm btn-light" (click)="closeSuggestionConfigModal()">Cancel</button>
          <button type="button" class="btn btn-sm btn-dark" (click)="generateSuggestionWithConfig()">
            <i class="bi bi-lightning"></i> Generate
          </button>
        </div>
      </div>
    </div>
  </div>


  <div>
    <p 
      class="subtitle-description mt-4" 
      *ngIf="this.currentDQModel?.status !== 'finished'" 
      (click)="toggleSuggestionsSectionVisibility()" 
      style="cursor: pointer;"
      [attr.data-tooltip]="!isSuggestionsSectionVisible ? 
      'In this section, you can get an AI-powered suggestion for a DQ Dimension and Factor. This suggestion is based on context components and existing DQ problems to help you get started.' : null">
      Suggested DQ Dimensions and DQ Factors
      <i class="bi" [ngClass]="isSuggestionsSectionVisible ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
    </p>

    <div class="flex-container" *ngIf="isSuggestionsSectionVisible && this.currentDQModel?.status !== 'finished'">
      <div class="section-container">
        <div class="px-3 py-1">
          <div *ngIf="!getSuggestedFactor()">
            <div class="label-selected">
              <label class="label-title-selected-ctx">Suggested DQ Dimension and DQ Factor:</label>
            </div>

            <!-- INFO MESSAGES -->
            <div class="px-4">
              <div  class="alert alert-light mb-3 mt-2">
                <i class="bi bi-info-circle me-1 mb-1"></i>
                Generate a suggested DQ Dimension and DQ Factor pair using AI.
              </div> 
              <div class="alert alert-info mt-2 d-flex align-items-start">
                <i class="bi bi-info-circle me-2 mt-3"></i>
                <div>
                  Context components and prioritized DQ problems can suggest and guide the selection of relevant DQ dimensions and factors, helping you focus on key aspects of data quality and associate them with your choices, which in turn helps track and trace your decisions during the creation or development of the Data Quality Model.
                </div>
              </div>
            </div>

          </div>

          <div *ngIf="getSuggestedFactor()" class="label-container mt-2">
            <div class="label">
              <label class="label-title">DQ Dimension:</label>
              <span class="label-value">
                {{ getSuggestedDimension()?.name }}
                <i class="bi bi-info-circle" 
                    data-bs-toggle="tooltip" 
                    data-bs-placement="top" 
                    title="{{ getSuggestedDimension()?.semantic }}">
                </i>
              </span>
            </div>
            <div class="label">
              <label class="label-title">DQ Factor:</label>
              <span class="label-value">
                {{ getSuggestedFactor()?.name }} 
                <i class="bi bi-info-circle" 
                    data-bs-toggle="tooltip" 
                    data-bs-placement="top" 
                    title="{{ getSuggestedFactor()?.semantic }}">
                </i>
              </span>
            </div>
          </div>

          <br>
        
          <div *ngIf="getSuggestedFactor()" class="px-4">
            <div class="label-selected">
              <label class="label-title-selected-ctx">Based on:</label>
            </div>
            <div *ngIf="getSuggestedFactor()" class="alert alert-primary mb-1 d-flex align-items-start">
              <i class="bi bi-lightbulb me-2 mt-1"></i>
              <div>
                {{ generatedSuggestion?.rationale }}
              </div>
            </div>
          </div>
          
          <br>
          
          <!-- SECCION CTX COMPONENTS and DQ PROBLEMS (supported by)-->
          <div *ngIf="getSuggestedFactor()" class="ctx-and-problems-main-container mb-4">
            <!-- From Context Components selection -->
            <div class="ctx-components-selection-container">
              <div class="d-flex justify-content-between px-2" style="gap: 2px;">
                <div class="from-ctx-components flex-fill">
                  <!-- Título colapsable -->
                  <div class="label-selected">
                    <label class="label-title-selected-ctx" (click)="toggleCtxSuggestionVisibility()" style="cursor: pointer;">
                      Context Components: <i class="bi" [ngClass]="isCtxSuggestionVisible ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                    </label>
                  </div>
    
                  <!-- Components select values -->
                  <div *ngIf="isCtxSuggestionVisible" class="ctx-selection-accordion-container">
                    <div class="accordion" id="accordionPanelsStayOpenExample">
                      <div *ngFor="let category of categories; let i = index" class="accordion-item">
                        <h2 class="accordion-header" [id]="'panelsStayOpen-heading' + i">
                          <button
                            class="accordion-button"
                            type="button"
                            data-bs-toggle="collapse"
                            [attr.data-bs-target]="'#panelsStayOpen-collapse' + i"
                            [attr.aria-controls]="'panelsStayOpen-collapse' + i"
                            [attr.aria-expanded]="hasSelectedComponents(category) ? 'true' : 'false'"
                            [class.collapsed]="!hasSelectedComponents(category)"
                            style="padding: 0.6rem 0.9rem;">
                            {{ formatCtxCompCategoryName(category) }}
                          </button>
                        </h2>
                        <div
                          [id]="'panelsStayOpen-collapse' + i"
                          class="accordion-collapse collapse"
                          [class.show]="hasSelectedComponents(category)"
                          [attr.aria-labelledby]="'panelsStayOpen-heading' + i">
                          <div class="accordion-body">
                            <div *ngFor="let item of allContextComponents[category]" class="ms-2 form-check">
                              <input
                                class="form-check-input"
                                type="checkbox"
                                [id]="'checkbox-' + category + '-' + item.id"
                                [checked]="isComponentSelectedInSuggestions(category, getFirstNonIdAttribute(item))"
                                (change)="onCtxComponentsCheckboxChange_suggestion(item.id, category, getFirstNonIdAttribute(item), $event)"/>
                              <label class="form-check-label" [for]="'checkbox-' + category + '-' + item.id">
                                {{ getFirstNonIdAttribute(item) }} <i class="bi bi-info-circle"></i>
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div> 
              </div>
            </div>

            <!-- From DQ Problems selection -->
            <div class="dq-problems-selection-container">
              <div class="d-flex justify-content-between px-2" style="gap: 2px;">
                <div class="from-ctx-components flex-fill">
                  <div class="label-selected">
                    <label class="label-title-selected-ctx">From DQ Problems:</label>
                  </div>

                  <!-- DQ Problems select values -->
                  <div class="dq-problems-accordion-container">
                    <div class="ctx-selection-accordion-container">
                      <div class="checkbox-container">
                        <div *ngFor="let problem of selectedPrioritizedProblems; let i = index" class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            [id]="'checkbox' + i"
                            [value]="problem"
                            [checked]="isProblemSelectedInSuggestions(problem.dq_problem_id)"
                            (change)="onCheckboxSuggestionsProblemsChange(problem, $event)"/>
                          <label class="form-check-label" [for]="'checkbox' + i">
                            {{ problem.description }}
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div> 
              </div>
            </div>
          </div>
          
          <!-- BUTTONS -->
          <div class="d-flex gap-3 mb-3 ">
            <button
            *ngIf="getSuggestedFactor()"
              type="button"
              class="btn btn-sm btn-dark"
              (click)="openConfirmationModal(
                'Add to DQ Model',
                'Are you sure you want to add this dimension and factor to the DQ Model?',
                'addDimAndFactorRecommendedToDQModel',
                ctxComponentsChecked_suggestion,
                selectedProblemsSuggestions
              )">
              Add to DQ Model
            </button>

            <button 
              type="button" 
              class="btn btn-sm btn-info" 
              (click)="openSuggestionConfigModal()" 
              style="width: auto;" 
              [disabled]="isLoading">
              <i *ngIf="!isLoading" class="bi bi-lightning"></i>
              <span *ngIf="!isLoading">Generate</span>
              <span *ngIf="isLoading">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Generating...
              </span>
            </button>

            <!--
            <button 
              *ngIf="getSuggestedFactor()"
              type="button" 
              class="btn btn-sm btn-light mx-2" 
              (click)="openSuggestionConfigModal()" 
              style="width: auto;">
              <i class="bi bi-slash-circle me-1"></i> Ignore
      
            </button>-->

            <!--<button 
              type="button" 
              class="btn btn-sm btn-info mx-2" 
              (click)="generateDimensionFactorSuggestion()" 
              style="width: auto;" 
              [disabled]="isLoading">
              <i *ngIf="!isLoading" class="bi bi-lightning"></i>
              <span *ngIf="!isLoading">Generate</span>
              <span *ngIf="isLoading">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Generating...
              </span>
            </button>-->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- SECTION - DQ MODEL VIEW: Dimensions and Factors in DQMODEL -->
  <div>
    <p class="subtitle-description mt-4">Dimensions and Factors added to DQ Model</p>
    <div class="flex-container">
      <div class="section-container">
        <!-- DQ DIMENSIONS and DQ FACTORS ADDED to DQ MODEL -->
        <div>
          <div class="label-container-selected py-2 px-4">
            <div  *ngIf="currentDQModel && project" >
              <div class="dqmodel-title">
                <span class="label-name-dqmodel">{{ currentDQModel.name }} {{ currentDQModel.version }} (id: {{ project.dqmodel_version }})</span>
                <span *ngIf="currentDQModel.status === 'finished'" class="badge rounded-pill bg-dark">Finished</span>
                <span *ngIf="currentDQModel.status === 'draft'" class="badge rounded-pill bg-warning">Draft</span>
              </div>
              <div class="dqmodel-preview-details-container">
                <div class="label-selected">
                  <label class="label-title-selected">Creation date:</label>
                  <span class="label-value-selected">{{ currentDQModel.created_at | date:'MMM dd HH:mm yyyy' }}</span>
                </div> 
                <div class="label-selected">
                  <label class="label-title-selected">Context version:</label>
                  <span class="label-value-selected">CtxA v1.0 (id: {{ project.context_version }})</span>
                </div>  
                <div class="label-selected">
                  <label class="label-title-selected">Data at hand:</label>
                  <span class="label-value-selected">Data at Hand Id: {{ project.data_at_hand }}</span>
                </div> 
                <div class="label-selected">
                  <label class="label-title-selected">DQ Dimensions:</label>
                </div>
              </div>
            </div>

            <!-- Accordion DIMENSIONS DQMODEL -->
            <div  *ngIf="dimensionsWithFactorsInDQModel" class="dimensions-factors-selected-accordion-container">
              <div class="accordion mx-1 mt-1" id="accordionDimensions">
                <div class="accordion-item mb-2" *ngFor="let dim of dimensionsWithFactorsInDQModel; let i = index"
                style="border: 1px solid #dee2e6; border-radius: 5px; overflow: hidden;">
                  <h2 class="accordion-header" [id]="'heading' + i">
                    <button
                      class="accordion-button"
                      [ngClass]="{ 'collapsed': i !== 0 }"
                      type="button"
                      data-bs-toggle="collapse"
                      [attr.data-bs-target]="'#collapse' + i"
                      [attr.aria-expanded]="i === 0 ? 'true' : 'false'"
                      [attr.aria-controls]="'collapse' + i"
                      style="padding: 0.6rem 0.9rem;">
                    <span>
                      <label class="label-title">DQ Dimension:</label> <span class="dimension-name">{{ dim.dimension.dimension_name }}</span>
                    </span>
                    </button>
                  </h2>
                  <div
                    [id]="'collapse' + i"
                    class="accordion-collapse collapse"
                    [class.show]="i === 0"
                    [attr.aria-labelledby]="'heading' + i">
                    <div class="accordion-body">
                      <div class="label-selected">
                        <label class="label-title-selected">Semantic:</label>
                        <span class="label-value-selected">{{ dim.baseAttributes.semantic }}</span>
                      </div>

                      <!-- Componentes de contexto -->
                      <div class="label-selected">
                        <label class="label-title-selected">Suggested by (Ctx. Components):</label>
                        <span class="label-value-selected">
                          <!-- Solo lectura -->
                          <div *ngIf="!dim.dimension.isEditing">
                            <ul>
                              <li *ngFor="let category of getContextComponentCategories(dim.dimension.context_components)">
                                {{ formatCtxCompCategoryName(category) }}:
                                <ul>
                                  <li *ngFor="let componentId of dim.dimension.context_components[category]">
                                    {{ getFirstAttribute(category, componentId) }}
                                    <a href="javascript:void(0)" (click)="openContextComponentModal(category, componentId)" style="text-decoration: none;">
                                      <i class="bi bi-zoom-in"></i> 
                                    </a>
                                  </li>
                                </ul>
                              </li>
                            </ul>
                          </div>

                          <!-- Vista de edición (acordeón) -->                 
                          <div *ngIf="dim.dimension.isEditing" class="ctx-selection-accordion-container-edit">
                            <div class="accordion" id="accordionPanelsStayOpenExample">
                              <div *ngFor="let category of categories; let i = index" class="accordion-item">
                                <h5 class="accordion-header" [id]="'panelsStayOpen-heading' + i">
                                  <button
                                    class="accordion-button"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    [attr.data-bs-target]="'#panelsStayOpen-collapse' + i"
                                    [attr.aria-controls]="'panelsStayOpen-collapse' + i"
                                    [attr.aria-expanded]="hasComponents(category, dim.dimension.tempContextComponents) ? 'true' : 'false'"
                                    [class.collapsed]="!hasComponents(category, dim.dimension.tempContextComponents)"
                                    style="padding: 0.6rem 0.9rem;">
                                    {{ formatCtxCompCategoryName(category) }}
                                  </button>
                                </h5>
                                <div
                                  [id]="'panelsStayOpen-collapse' + i"
                                  class="accordion-collapse collapse"
                                  [class.show]="hasComponents(category, dim.dimension.tempContextComponents)"
                                  [attr.aria-labelledby]="'panelsStayOpen-heading' + i">
                                  <div class="accordion-body">
                                    <div *ngFor="let item of allContextComponents[category]" class="form-check">
                                      <input
                                        class="form-check-input"
                                        type="checkbox"
                                        [id]="'checkbox-' + category + '-' + item.id"
                                        [checked]="isComponentSelected_editing(category, item.id, dim.dimension.tempContextComponents)"
                                        (change)="onCtxComponentsCheckboxChange_editing(item.id, category, dim.dimension)"/>
                                      <label class="form-check-label" [for]="'checkbox-' + category + '-' + item.id">
                                        {{ getFirstNonIdAttribute(item) }}
                                      </label>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          </div>
                        </span>
                      </div>

                      <!-- Modal para mostrar todos los atributos -->
                      <div class="modal fade" id="contextComponentModal" tabindex="-1" aria-labelledby="contextComponentModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="contextComponentModalLabel">Component Details</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <ul>
                                <li *ngFor="let key of selectedComponentKeys">
                                  <strong>{{ formatCtxCompCategoryName(key) }}:</strong> {{ selectedComponentDetails[key] }}
                                </li>
                              </ul>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- DQ Problems -->
                      <div class="label-selected">
                        <label class="label-title-selected">Based on (DQ Problems):</label>
                        <span class="label-value-selected">
                          <!-- DQ Problems - Solo lectura -->
                          <div *ngIf="!dim.dimension.isEditing && dim.dimension.dq_problems_details?.length > 0">
                            <ul>
                              <li *ngFor="let problem of dim.dimension.dq_problems_details">
                                {{ problem.description }}
                              </li>
                            </ul>
                          </div>
                          
                          <!-- DQ Problems - Edicion -->
                          <div *ngIf="dim.dimension.isEditing" class="dq-problems-accordion-container-edit">
                            <div class="checkbox-container">
                              <div *ngFor="let problem of selectedPrioritizedProblems; let i = index" class="form-check">
                                <input
                                  class="form-check-input"
                                  type="checkbox"
                                  [id]="'problem-checkbox-' + problem.dq_problem_id"
                                  [checked]="isProblemSelected(problem.dq_problem_id, dim.dimension.dq_problems)"
                                  (change)="onProblemCheckboxChange(problem.dq_problem_id, dim.dimension)"/>
                                <label class="form-check-label" [for]="'problem-checkbox-' + problem.id">
                                  {{ problem.description }}
                                </label>
                                </div>
                              </div>
                          </div>

                        </span>
                      </div>

                      <div class="label-selected">
                        <label class="label-title-selected">DQ Factors:</label>
                      </div>

                      <!-- Si hay Factores definidos para Dimension -->
                      <div *ngIf="dim.factors.length > 0; else noFactors">
                      <!-- Accordion FACTORS  -->
                      <div class="accordion mx-3" [id]="'factorAccordion' + i">
                        <div class="accordion-item" *ngFor="let factor of dim.factors; let j = index">
                          <h2 class="accordion-header" [id]="'factorHeading' + i + '-' + j">
                            <button
                              class="accordion-button collapsed"
                              type="button"
                              data-bs-toggle="collapse"
                              [attr.data-bs-target]="'#factorCollapse' + i + '-' + j"
                              aria-expanded="false"
                              [attr.aria-controls]="'factorCollapse' + i + '-' + j"
                              style="padding: 0.6rem 0.9rem;">
                              <span>
                                <label class="label-title">DQ Factor:</label> 
                                <span class="dimension-name">{{ factor.factor_name }}</span>
                              </span>
                            </button>
                          </h2>
                          <div
                            [id]="'factorCollapse' + i + '-' + j"
                            class="accordion-collapse collapse"
                            [attr.aria-labelledby]="'factorHeading' + i + '-' + j"
                            [attr.data-bs-parent]="'#factorAccordion' + i">
                            <div class="accordion-body">
                              <div class="label-selected">
                                <label class="label-title-selected">Semantic:</label>
                                <span class="label-value-selected">{{ factor.baseAttributes.semantic }}</span>
                              </div>

                              <!-- Componentes de contexto -->
                              <div class="label-selected">
                                <label class="label-title-selected">Ctx (Arises from):</label>
                                <span class="label-value-selected">
                                  <!-- Solo lectura -->
                                  <div *ngIf="!factor.isEditing">
                                    <ul>
                                      <li *ngFor="let category of getContextComponentCategories(factor.context_components)">
                                        {{ formatCtxCompCategoryName(category) }}:
                                        <ul>
                                          <li *ngFor="let componentId of factor.context_components[category]">
                                            {{ getFirstAttribute(category, componentId) }}
                                            <a href="javascript:void(0)" (click)="openContextComponentModal(category, componentId)">
                                              <i class="bi bi-zoom-in"></i> 
                                            </a>
                                          </li>
                                        </ul>
                                      </li>
                                    </ul>
                                  </div>

                                  <!-- Ctx Components - Edicion -->
                                  <div *ngIf="factor.isEditing" class="ctx-selection-accordion-container-edit">
                                    <div class="accordion" id="accordionPanelsStayOpenExample">
                                      <div *ngFor="let category of categories; let k = index" class="accordion-item">
                                        <h5 class="accordion-header" [id]="'panelsStayOpen-heading' + k">
                                          <button
                                            class="accordion-button"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            [attr.data-bs-target]="'#panelsStayOpen-collapse' + k"
                                            [attr.aria-controls]="'panelsStayOpen-collapse' + k"
                                            [attr.aria-expanded]="hasComponents(category, factor.tempContextComponents)"
                                            [class.collapsed]="!hasComponents(category, factor.tempContextComponents)"
                                            style="padding: 0.6rem 0.9rem;">
                                            {{ formatCtxCompCategoryName(category) }}
                                          </button>
                                        </h5>
                                        <div
                                          [id]="'panelsStayOpen-collapse' + k"
                                          class="accordion-collapse collapse"
                                          [class.show]="hasComponents(category, factor.tempContextComponents)"
                                          [attr.aria-labelledby]="'panelsStayOpen-heading' + k">
                                          <div class="accordion-body">
                                            <div *ngFor="let item of allContextComponents[category]" class="form-check">
                                              <input
                                                class="form-check-input"
                                                type="checkbox"
                                                [id]="'checkbox-' + category + '-' + item.id"
                                                [checked]="isComponentSelected_editing(category, item.id, factor.tempContextComponents)"
                                                (change)="onCtxComponentsCheckboxChange_editing(item.id, category, factor)"/>
                                              <label class="form-check-label" [for]="'checkbox-' + category + '-' + item.id">
                                                {{ getFirstNonIdAttribute(item) }}
                                              </label>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </span>
                              </div>

                              <!-- DQ Problems -->
                              <div class="label-selected">
                                <label class="label-title-selected">DQ Problems (Used):</label>
                                <span class="label-value-selected">

                                  <!-- DQ Problems - Solo lectura -->
                                  <div *ngIf="!factor.isEditing">
                                    <ul>
                                      <li *ngFor="let problem of factor.dq_problems_details">
                                        {{ problem.description }}
                                      </li>
                                    </ul>
                                  </div>

                                  <!-- DQ Problems - Edicion -->
                                  <div *ngIf="factor.isEditing" class="dq-problems-accordion-container-edit">
                                    <div class="checkbox-container">
                                      <div *ngFor="let problem of selectedPrioritizedProblems; let i = index" class="form-check">
                                        <input
                                          class="form-check-input"
                                          type="checkbox"
                                          [id]="'problem-checkbox-' + problem.dq_problem_id"
                                          [checked]="isProblemSelected(problem.dq_problem_id, factor.dq_problems)"
                                          (change)="onProblemCheckboxChangeEditFactor(problem.dq_problem_id, factor)"/>
                                        <label class="form-check-label" [for]="'problem-checkbox-' + problem.id">
                                          {{ problem.description }}
                                        </label>
                                        </div>
                                      </div>
                                  </div>


                                </span>
                              </div>

                              <!-- Botones de edición -->
                              <div *ngIf="currentDQModel.status === 'draft'">
                                <div class="d-flex gap-2 mt-2 mb-2">
                                  <button
                                    (click)="openConfirmationModal(
                                      'Remove DQ Factor',
                                      'Are you sure you want to remove this factor from the DQ Model?',
                                      'deleteFactor',
                                      factor.id
                                    )"
                                    class="btn btn-outline-danger btn-sm">
                                    <i class="bi bi-trash3"></i> Remove DQ Factor
                                  </button>
                                  <button
                                    class="btn btn-light btn-sm"
                                    (click)="toggleEditDQFactorVisibility(factor)">
                                    {{ factor.isEditing ? 'Cancel' : 'Edit' }}
                                  </button>
                                  <button
                                    *ngIf="factor.isEditing"
                                    (click)="saveFactorContextComponents(factor, dim.dimension.id)"
                                    class="btn btn-dark btn-sm">
                                    Save Changes
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      </div>

                      <!-- Si NO hay Factores definidos para Dimension -->
                      <ng-template #noFactors>
                        <!-- MENSAJE INFORMATIVO -->
                        <div class="px-2">
                          <div  class="alert alert-warning">
                            <i class="bi bi-exclamation-circle me-2"></i>
                            No factors have been defined for this dimension. <br> 
                            Defining at least one metric for each factor will be necessary to complete the DQ Model.
                          </div>
                        </div>

                      </ng-template>


                      
                      <br>
                      <div *ngIf="currentDQModel.status === 'draft'">
                        <div class="d-flex gap-2 mt-3 mb-2">
                          <button
                            (click)="openConfirmationModal(
                              'Remove DQ Dimension',
                              'Are you sure you want to remove this dimension and its associated factors?',
                              'deleteDimension',
                              dim.dimension.id
                            )"
                            class="btn btn-outline-danger btn-sm flex-grow-0">
                            <i class="bi bi-trash3"></i> Remove DQ Dimension
                          </button>
                          <button class="btn btn-light btn-sm flex-grow-0" (click)="enableDQDimensionEdition(dim.dimension)">
                            <span *ngIf="!dim.dimension.isEditing ">
                              <i class="bi bi-pencil"></i> Edit
                            </span>
                            <span *ngIf="dim.dimension.isEditing ">
                               Cancel
                            </span>
                            <!-- {{ dim.dimension.isEditing ? 'Cancel' : 'Edit' }} -->
                          </button>
                          <button *ngIf="dim.dimension.isEditing" (click)="saveDQDimensionChanges(dim.dimension)" class="btn btn-dark btn-sm flex-grow-0">
                            Save Changes
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <p *ngIf="errorMessage" class="error-message">{{ errorMessage }}</p>
        <!-- MENSAJE INFORMATIVO -->
        <div class="px-2 py-2">
            <div *ngIf="noDimensionsMessage" class="alert alert-warning mt-2">
              <i class="bi bi-exclamation-circle me-2"></i>
              No dimensions have been added to the DQ Model.<br>
              You must add at least one dimension in order to proceed.
            </div>
          </div>
         
      </div>
    </div>
  </div>

  <!-- Modal de confirmación -->
  <app-confirmation-modal
    [isOpen]="isConfirmationModalOpen"
    [title]="confirmationModalTitle"
    [message]="confirmationModalMessage"
    (confirm)="handleConfirm()"
    (cancel)="handleCancel()">
  </app-confirmation-modal>

  <app-stepper
    [currentStep]="currentStep"
    [totalSteps]="steps.length"
    [isNextStepEnabled]="isNextStepEnabled"
    (stepChange)="onStepChange($event)">
  </app-stepper>

  <app-context-components></app-context-components>
</div>